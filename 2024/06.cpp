#include <aoc.h>
using namespace std;
using namespace aoc;

const vector<string> inputTestdata = {
    "....#.....",
    ".........#",
    "..........",
    "..#.......",
    ".......#..",
    "..........",
    ".#..^.....",
    "........#.",
    "#.........",
    "......#..."
};

const vector<string> inputData = {
    ".#..#......................#........#........................................#.............#......#...............#...............",
    ".......#...........#........................#..............#.....#......#..##............#.....#.....................##...........",
    ".#.....#........#.##..#.............#...........#................#............#.#.........#.....................#......#..........",
    "...........#...#.#.................................#.....................#............#.....#.#................#..#...............",
    "..................................................................................#...............................................",
    "..................#....................#.................#.........#..#.................#...........#...................#.........",
    ".......#......#................#.......#............................#.................#.........................#...#........#....",
    "................................#..............................................................#.........#.........#..............",
    ".......................................................#............#......#........#.#...................#............#..........",
    ".....#......#..............................................#..............................................#.......................",
    "......#..........................................................................................#................#...............",
    "............................#..................#............#..#.#..............#..........#......................................",
    "......#..........................#...................#..........#....#.........................#.......................#....#..#..",
    "..................................#..........#....................................................................#........#......",
    "..#.................................#..................................................#......................#...................",
    ".....#............#..................#......#...................................#.#........#.#......#........#....................",
    "........#......................#.....#...#.##................................#......#.............................................",
    "...........#.........#...............................................................................#............................",
    "..................................#...##...............................#.............#.........................................##.",
    "..........................#.#..#......................................#........#..............................#...................",
    "......#...........###..#....#........................................................................................#............",
    "..............#.....................................................................#......##.............#.......................",
    ".................................#...................#.........#..............................................#...........#.......",
    "....................#..#...................................................#................................#........#............",
    "........................................#.#.#..................#....................#.....#.................#.....................",
    ".........................#....#.....#.................##...............................................#.......#...#..............",
    "..#.........................#....................#.........................#..............................#...................#...",
    "..................##....#..#..#.#.................................................................#...............................",
    "..............#........................................................#.............................#......#.....................",
    ".................#...........#........................#......#..........##....................#.................................#.",
    "..........................#.............................................#..#.................................#.........#...#......",
    "..#..................##.....................................................#.....................#.......#.....#.................",
    "....#.........................................#..................#.#.........................#.......................#............",
    "...#.....#.#..............................................................#................#......................#...#........#..",
    ".............................#..#......#.....................................................##...................................",
    "...........#......................#....#.........#........................#......................................................#",
    "............#.............................................#.................................#....#................................",
    "..............................................................#.............#................#.........#.........................#",
    "..........................................#....#........#......................#.....#.............#..............................",
    "..#..#.............#...............................................#.....................................................#........",
    "................................................................................#.............#...................................",
    "...............................................#.......................#................#............#....................#.#.....",
    ".......................#.............................#.#..................#...#....#.................................#...#.....#..",
    ".......................#...........................#.........................................#.........#.........................#",
    "...#.........#.....#..........................................#...................................................................",
    "..........#..#...#...#........................#..........#..........................................#......#.........#............",
    "...............#............................#.#...................##.....................................................#........",
    ".........................................................#....................#........................#.........#....##....#...#.",
    "......................................#.#................................................#........................#...............",
    "..........#.............................................................#..#..#..............................#...#...#.#..........",
    ".........#.....................................................................................#...........#..#......#..........#.",
    "............................#....................#..............#...#.............................................................",
    "...........................................................#........#......................#.................................#....",
    ".........#..................#.........#.......#...............................#................#.............#...........#........",
    "............................#.........#...........................................................................................",
    "................................#...........#.......................................#..........#.#.....#..........................",
    "..........................................#.................................................................................#.....",
    "..............#...............................................#...................................................................",
    "...#....#.....................#..........#..#......................#..............................................................",
    ".......................#..........#.................................................#......#.............#........#....#..........",
    ".........................................................................#.#......................................#...............",
    "..........................................#.......................#...............................................#.........#...#.",
    "............................#.......................................................#...#.........#..#...##........#..............",
    "...........................................................................#..............#..........#.............#..............",
    "#............#..#...#..#........#....................#...........#..#.........................................#..........#........",
    "...........................................................................#......#..^.........#.........#........................",
    "......#............................#.............................................................................................#",
    "......................#.....#.......................................................#........................#..........#.........",
    "................#....#.......#.............................#..............#....................#....#....................#........",
    "......#...................................#..................................................................#....................",
    ".....#..............#.#...........................................................#.................#.........#......#........#...",
    "..#..#..#..#........#...........#...........#....##...........#.....................#.............................................",
    "......................##..........................................................................................................",
    "...........#............#.........................................................#.....#.....#....................#..............",
    "#.............#..........#...............#..#.......................................#..............................#..............",
    "#.......................................#........#....#.......................................................#..#.............#..",
    ".......................#...#.....#..#...........................#...........#.........................#...#...#................#..",
    "#...............................................................#........................................#.....................#..",
    "..#.....................#............................##..........#..................##...#.....................................#..",
    ".......#...................##..........................................#........#.................................................",
    ".........................................................#............................................#...............##..........",
    ".......................#......#..............................................................................................#....",
    "...........#.......................................#.................................#..........#.............#..................#",
    "....#.............#......#............................#........................#...................#......#.....#..........#......",
    ".................................................................#................................#...............................",
    "..........................................................#.......................#...#...........................................",
    ".#............#...........................................#............................#..............................#...#.#.....",
    "..#.................................................#.............................................#.....................#.........",
    ".....#...............#...#.......................#.......................#......................................#...........#.....",
    "...........#...#................................#.............................#........#.........................................#",
    "..............................#.....................#......................#...#................................#.................",
    ".........#.....................................................#...#......................................#................#......",
    ".....#.....................#.................................#...................................................#....#......#....",
    "................#.........#.........................#...........#...#..............................................#..............",
    ".................................#....................................................................#..................#......#.",
    "#..............#......................................................................#.....#.....................................",
    ".............#......#..............##.#............#.#.....................#..........#.......#..........................#........",
    ".......#............#.................#...........................................................#.............................#.",
    "...........................#.......................#..................#....#....................................#.................",
    "....#.....##...........................................#...........#.............#........................#.....#.................",
    "............................#..............................................##..........#..................#.......#...............",
    "#.............................#.............#...............................#..........#...#.....................................#",
    ".............#.......#.....................................#...###......##...............#..#..............#.........#............",
    ".......#......##.....#..................#....................................#............#................#...................#..",
    "..............#......................#............#........#.....................................................#.........#....#.",
    ".............#.......#...............................................##......#...........#...........#............................",
    "#.#....#..............................................................#.........................................#...............#.",
    "...#....#........................#.#.......#.....................#.............................#.#......................#.#.......",
    ".##........................................................#.#...................#.....#.................................#........",
    "............................#.#..................................#....#...........................................................",
    "..................................................#......#...............#...............................#..#..#.......#..........",
    "..........#......................#..........#.........................#...............#..##.....................#.................",
    "...#.......#.........................................................#............#.........#...#................................#",
    "....................#...................................#..........#.....#...#..#........#............#................#..........",
    "...............................#........#.....................................#.....................................#.........#...",
    "....#....................#...................................#.#........................#.........................................",
    ".........#............................#.....................#.............#...........##.........#................................",
    ".............................................##........................................#......#................................#..",
    "...#...............................#.#...#...........#.............................#.............................................#",
    ".............................#...........#................#..................................................#............#.......",
    "................#....................................................................................#..#.#.......................",
    "...#.............#.#..#.......................#.................#...............#..#....#..............#............#......#......",
    "...........#......#............................#.....#..........#.#.................#..........#...........#...............#...#..",
    "....#..................#...........................#.........#............#........#..........#..............................#....",
    "..........#.......#...................#......#.......#.......#....................#.....................................#.........",
    "...#....................................................#......#...#...................#.....................#....................",
    "....................#..#.....#......#...................#............#.......................................#...............#....",
    ".........................#.......#.....#..#.......#...........#......##..............................#.........#..................",
    ".#...........#...#.........#....#...#.......#....#........................#...................#...#..................#............",
    ".........##......#..............................#....................#..#...#..................#............................#....."
};

class GuardGallivant {
public:
    GuardGallivant(string _file, string _extension)
        : datafile(_file, _extension)
        , lab(datafile.getXSize(), datafile.getYSize())
        , runner(datafile.getXSize(), datafile.getYSize())
    {
        // Parse data
        for (auto y = 0; y < datafile.getYSize(); ++y) {
            for (auto x = 0; x < datafile.getXSize(); ++x) {
                lab[pair<size_t, size_t>(x, y)] = datafile.getLines()[y][x];
                if ('^' == datafile.getLines()[y][x])
                    runner.setPosition(pair<long, long>(x, y));
            }
        }

        runner.setMaze(lab);
        runner.setblockedFieldTypes("#O");
        runner.setOrientation('N');
        runner.setMarkAsSeen('X');
    }

    static long nextstep(mazerunner& r, int lastMove)
    {
        switch (lastMove) {
        case 1:
            r.rotate('R');
            lastMove = 0;
            break;
        case 0:
            lastMove = r.move();
            break;
        default:
            return -1;
            break;
        }
        return lastMove;
    }

    static long stepTillEnd(mazerunner& r)
    {
        int lastMove = 0;

        while (-1 < lastMove) {
            lastMove = nextstep(r, lastMove);
        }

        return lastMove;
    }

    long getGuardsRoute()
    {
        // Make working copy
        auto r = runner;
        stepTillEnd(r);
        long GuardsRoute = r.getSeenFields();

        cout << "GuardsRoute: " << GuardsRoute << endl;
        return GuardsRoute;
    }

    long getNumOfLoops()
    {
        // Make working copy
        auto r = runner;
        long NumOfLoops = 0;

        stepTillEnd(r);

        for (auto y = 0; y < datafile.getYSize(); ++y) {
            for (auto x = 0; x < datafile.getXSize(); ++x) {
                if ('X' == r.getMaze()[{ x, y }]) {
                    // Make working copy
                    auto r2 = runner;
                    r2.getMaze()[{ x, y }] = 'O';

                    if (-2 == stepTillEnd(r2))
                        ++NumOfLoops;
                }
            }
        }
        cout << "NumOfLoops: " << NumOfLoops << endl;
        return NumOfLoops;
    }

private:
    aocdatafile datafile;
    maze lab;
    mazerunner runner;
};

TEST_CASE("Testdata")
{
    GuardGallivant problemData(__FILE__, "example");
    REQUIRE(41 == problemData.getGuardsRoute());
    REQUIRE(6 == problemData.getNumOfLoops());
}

TEST_CASE("GuardGallivant")
{
    GuardGallivant problemData(__FILE__, "mydata");
    REQUIRE(5030 == problemData.getGuardsRoute());
    REQUIRE(1928 == problemData.getNumOfLoops());
}