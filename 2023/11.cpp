#include <iostream>
#include <set>
#include <string>
#include <utility>
#include <vector>

#include <manhattan.h>

#include <catch2/catch_test_macros.hpp>

using namespace std;

const vector<string> inputTestdata = {
    "...#......",
    ".......#..",
    "#.........",
    "..........",
    "......#...",
    ".#........",
    ".........#",
    "..........",
    ".......#..",
    "#...#....."
};

const vector<string> inputData = {
    "...........#...............................................#...................#.....#.............#........................................",
    "..................#..................................#..................#.....................#................#...................#.......#",
    "....#........................................................................................................................#..............",
    "..............................#........#..................................................#.................................................",
    ".............#........#...........................#..........................#..............................#...............................",
    "......................................................................................................#.............#.......................",
    "...........................................................#......................#........................................#................",
    ".........#.....................................#.......................#..................................................................#.",
    "..................#.......#....................................................................#...................................#........",
    "#..........................................#...............................................................#......#.........................",
    "..................................................#.........................................................................................",
    "..............................................................#.....#....................#..................................................",
    "......#..............................#......................................................................................................",
    "...............................................#......#.................#..........#................................#.......................",
    "..............................................................................#........................#.................................#..",
    ".............#....................................................................................#............................#............",
    ".......................#.............................................#......................................................................",
    "...............................#....................#.........................................#.....................................#.......",
    "..........#.................................................................................................#...............................",
    "..........................................................................#.......#..........................................#..............",
    "...#..............................#............................#....................................#..................#....................",
    "..................#..........................#....................................................................................#.........",
    ".........................#.........................#.......#..........#...................#.................................................",
    "........#.....#.............................................................#...................#........#..................................",
    "..............................#.........#......................................................................................#......#.....",
    "......................................................#......................................................#..............................",
    "....................................................................................................#.......................................",
    ".............................................................#.......#.....................#.......................#...............#........",
    "..#...................#......................................................................................................#..............",
    "......................................#..........................#.....................#....................................................",
    ".............#..............................................................................................................................",
    "...............................#.................#.........................#...................#..............#.............................",
    "........................#...........................................................#................................................#......",
    "........................................#................................................#..........#......................................#",
    "......................................................................#............................................#......#.................",
    "............................................................................................................................................",
    "...........#................................................#.................................#.............................................",
    ".....................................#......#...............................................................................................",
    "....#............#..................................................#.............#....................#..........................#.........",
    "............................................................................................................................................",
    ".......................#.....#...........#............................................................................#..................#..",
    ".......#................................................#...............................#......#............................................",
    "...................................#...........................#...........#....................................#...........................",
    "#.............................................................................................................................#.............",
    "...............................#...........................#......................#.......................#.................................",
    "............#.............#..................#..............................................................................................",
    "....................................................#...............#........#.........#...........................................#........",
    "...............................................................................................................#......#...................#.",
    ".......#.............#..............#.......................................................................................................",
    ".............................................................................................................................#..............",
    "............................................................................................................................................",
    ".................#............#...............................#.......#......................#..........#...............#...................",
    "........................#..........................................................#................................................#.......",
    ".#.................................................#........................................................................................",
    "...........#.................................#.....................................................#........................................",
    "......................................#.....................................................................#......#........................",
    ".......#............#...................................................#.............................................................#.....",
    "...............#.....................................#........#...............#............................................#...............#",
    "...................................................................#....................#...................................................",
    ".................................................#..........................................................................................",
    "..................#........................#..................................................#.......#...............#.....................",
    "............................................................................................................................................",
    "......#...........................#..............................#..........................................................#...............",
    "...........................................................#.....................................................#..........................",
    "...........................#........................#..............................................................................#......#.",
    "...........#..............................................................#..................................#..............................",
    "..........................................#.................................................................................................",
    "...#..........................................................#.........................#.......................................#...........",
    "........................................................#......................#..........................#..........................#......",
    ".......................#.............................................#.............................#........................................",
    ".......................................................................................................................#....................",
    "......#......#....................#.........................................................................................................",
    "...............................................................#............#......#.....#..............#..........#..........#.............",
    ".#...............#.....................#......#.....#.......................................................................................",
    "...................................................................#.........................#...........................................#..",
    "............................................................................................................................................",
    "...........................................#...........................#..............................#.....................................",
    "......#....................................................#....................#..............................#....................#.......",
    "......................#.......#....................#........................................................................................",
    "............#.................................#................#...............................#....................#.......................",
    ".......................................#.................................................................................................#..",
    "............................................................................................................................................",
    "...#.....................#.........................................#...................#....................#....................#..........",
    ".................#..............#.....................................................................................................#.....",
    "...........................................................................#....................#.................#.........................",
    ".......#...................................................................................#................................................",
    "............#..........#....................................................................................................................",
    "......................................................................#.......#.............................................#...............",
    "........................................................................................................#...................................",
    "....#.........................................................#.............................................................................",
    "..........#....................#....................#......................#..................#......................#......................",
    "#...............#...................#.........#..........#...................................................#..............................",
    "...................................................................................................................................#........",
    "............................#.........................................................#.....................................................",
    "..........................................#...................................#.............................................................",
    "...#.................................................#.................................................................#.....#.............#",
    "......................#............#................................#...............................#.............#..................#......",
    ".........................................................................................................#..................................",
    "............#.....................................#.......................#...............#...................#.............................",
    ".#....................................#.....#....................................................................................#..........",
    "........#........................................................#..........................................................................",
    "...................#........#............................#.............................#..............................#.....................",
    "..............................................................................................................................#.............",
    "....................................................#..........................#............................................................",
    "........................#.......................................................................#............#............................#.",
    "..........................................#................................................................................#................",
    "..................#..........................................#.........................................#..............................#.....",
    ".............#...................................#..................#........................#..............................................",
    ".............................#...........................#......................#..................#........................................",
    "...................................#................................................................................#........#..............",
    "......#.................................................................#..............#....................................................",
    ".................#.........................................................................................#................................",
    "............................................................................................................................................",
    "...........................#...........#.........................................#...................#................#............#.....#..",
    ".#..........................................................................................#...............................................",
    ".....................#............................#.....#...................#....................................#..........................",
    ".............................................#.................#......................#.....................................................",
    "...................................#................................#.......................................................................",
    "......................................................................................................#.....................................",
    "......#.....#....................................................................................#.............................#.....#......",
    ".......................#...................#........#......................................#................................................",
    ".............................................................................................................#..............................",
    "#................#..........#........#..........#.......#......#........................................................................#...",
    ".....................................................................#.........#........#.....#......#.................#....................",
    "................................#...........................................................................................................",
    ".........................#..............#....................................................................................#..............",
    "..........#.................................................................................................................................",
    "..........................................................................................#........#........................................",
    ".................#...................#..........#.......#......#...................................................#...............#........",
    "............................................................................................................................................",
    ".............................#................................................................#.............................................",
    "...#.......#................................................................#........#...................#............#.........#..........#",
    "........................#.................#................#................................................................................",
    ".....................................................................#.....................................................#................",
    "....................................................#............................#......................................................#...",
    ".#..........................................................................................#......#...............#..............#.........",
    "............................................................................................................................................",
    "..........#........#............#.........................................................................#.................................",
    "........................................................#..........#........................................................................",
    ".....#.............................................#.........#....................#.............................#.........#................."
};

class CosmicExpansion {
public:
    CosmicExpansion(const vector<string>& _input)
        : input(_input)
    {
        cout << "Size of Input: " << input.size() << "x" << input[0].size() << endl;
    }

    void resetUniverse(long expansion)
    {
        // Find galaxies
        galaxies.clear();
        for (long row = 0; row < input.size(); ++row) {
            for (long column = 0; column < input[0].size(); ++column)
                if ('#' == input[row][column])
                    galaxies.push_back({ row, column });
        }
        cout << "Found " << galaxies.size() << " galaxies." << endl;

        // Search empty rows and columns
        set<long> emptyrows;
        set<long> emptycolumns;
        for (int i = 0; i < input.size(); ++i) {
            bool foundrow = false, foundcolumn = false;
            for (auto g : galaxies) {
                if (g.first == i)
                    foundrow = true;
                if (g.second == i)
                    foundcolumn = true;
            }
            if (!foundrow)
                emptyrows.insert(i);
            if (!foundcolumn)
                emptycolumns.insert(i);
        }
        cout << "Found " << emptyrows.size() << " empty rows and " << emptycolumns.size() << " empty columns." << endl;

        // Expand universe
        for (auto row = emptyrows.rbegin(); row != emptyrows.rend(); ++row) {
            for (auto& g : galaxies)
                if (g.first > *row)
                    g.first+=expansion;
        }

        for (auto column = emptycolumns.rbegin(); column != emptycolumns.rend(); ++column) {
            for (auto& g : galaxies)
                if (g.second > *column)
                    g.second+=expansion;
        }
    }

    long getSumOfDistances(long expansion)
    {
        long SumOfDistances = 0;
        resetUniverse(expansion);

        for (int g1 = 0; g1 < galaxies.size() - 1; ++g1)
            for (int g2 = g1 + 1; g2 < galaxies.size(); ++g2)
                SumOfDistances += manhattandistanceP(galaxies[g1], galaxies[g2]);

        cout << "SumOfDistances: " << SumOfDistances << endl;
        return SumOfDistances;
    }


private:
    const vector<string> input;

    vector<pair<long, long>> galaxies;
};

TEST_CASE("Testdata")
{
    CosmicExpansion CosmicExpansionData(inputTestdata);
    REQUIRE(374 == CosmicExpansionData.getSumOfDistances(1));
    REQUIRE(1030 == CosmicExpansionData.getSumOfDistances(9));
    REQUIRE(8410 == CosmicExpansionData.getSumOfDistances(99));
}

TEST_CASE("CosmicExpansion")
{
    CosmicExpansion CosmicExpansionData(inputData);
    REQUIRE(10289334 == CosmicExpansionData.getSumOfDistances(1));
    REQUIRE(649862989626 == CosmicExpansionData.getSumOfDistances(1000000 - 1));
}